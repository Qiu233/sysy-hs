# Static Analysis

之前为了性能考虑，想把整个静态检查都写到一起，但是写着写着发现实在是过于困难，所以决定把它分成独立的多个阶段。

每个阶段的输入都是AST，都要遍历一次AST，过程中会不断维护符号表，并且在AST上设置annotation，阶段结束的输出即是标注完成的AST。

每个阶段本身不会因为检测到错误而中断，因此会尽量收集足够多的错误。但是一个阶段结束时如果产生了错误，那么编译应该结束并报错，输出的AST有错，无法继续编译。

1. Name Resolution：确保程序没有使用未定义的变量或符号，并且没有冲突的重复定义。需要提前包含库函数的符号。
2. Type Checking：确保程序没有类型错误，并提供足够的类型标注，尤其需要标注类型转换 
    * 函数`putf`的参数处理需要额外的手段介入，但是目前的functional tests没有找到使用该函数的测例，所以打算等到功能大致实现完成再做。
3. Constant Computation：计算所有编译期常量并标注在AST上
    * 需要上一阶段标注的类型信息。由于类型检查通过，所以只需要判断是否是常量即可，然后根据规则计算。
    * 初值检查和整理：尤其是数组初值的整理，需要根据类型信息丢弃(警告)和补0。
    * 检查数组常量的左值，不能有修改的代码。
4. 基本块、DAG、优化、代码生成等其他阶段，目前还是先用LLVM吧，可以直接从AST生成LLVM IR，后端以后慢慢写。

